<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>구매 페이지</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    
    <!-- 카카오 주소 API 스크립트 -->
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <!-- 아임포트 API 스크립트 -->
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
    <script>
 	// 숫자를 3자리마다 콤마를 추가하고 원 단위를 붙이는 함수
    function formatPrice(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }
    
        $(function() {
            // 다음 주소 API를 사용하여 우편번호 찾기 기능 구현
            $('#findPostcode').on('click', function() {
                new daum.Postcode({
                    oncomplete: function(data) {
                        var roadAddr = data.roadAddress; // 도로명 주소
                        var jibunAddr = data.jibunAddress; // 지번 주소
                        var postCode = data.zonecode; // 우편번호

                        document.getElementById('postcode').value = postCode;
                        document.getElementById("address").value = roadAddr !== '' ? roadAddr : jibunAddr;

                        document.getElementById("address_detail").focus();  // 상세 주소에 포커스
                    }
                }).open();
            });
            
            // 쿠폰 선택하면 비동기로 적용
            $('#couponSelect').on('change', function() {
                var selectedCoupon = $(this).val();  // 선택한 쿠폰 코드 가져오기
                var totalPrice = $('#total_price').text().replace(',', '').replace('원', '');  // 원래 가격 가져오기
                
                if (selectedCoupon) {
                    // 선택한 쿠폰이 있는 경우에만 요청
                    $.ajax({
                        type: 'POST',
                        url: '/order/applyCoupon',  // 서버에서 쿠폰을 적용하는 API 엔드포인트
                        data: { couponCode: selectedCoupon,
                        		totalPrice : totalPrice},  // 선택한 쿠폰 코드 전달
                        success: function(response) {
                            if (response.status === 'success') {
                                // 할인 금액을 성공적으로 적용한 경우
                                $('#discount').text(formatPrice(response.discountAmount) + '원');
                                $('#final_price').text(formatPrice(response.finalPrice) + '원');
                                alert('쿠폰이 성공적으로 적용되었습니다.');
                            } else {
                                // 실패한 경우 처리
                                alert('쿠폰 적용에 실패했습니다. 다시 시도해주세요.');
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('쿠폰 적용 오류:', error);
                            alert('서버와의 통신 중 오류가 발생했습니다.');
                        }
                    });
                } else {
                    // 선택한 쿠폰이 없을 때 (초기 선택 상태)
                    alert('적용할 쿠폰을 선택해주세요.');
                }
            });
      
            	
            // 포인트 적용 버튼 클릭 시
	            $('#applyPointsBtn').on('click', function() {
					var points = $('#points').val();
					var finalPrice = $('#final_price').text().replace(',', '').replace('원', '');  // 쿠폰이 적용된 후 최종 금액 가져오기
			        var currentDiscount = $('#discount').text().replace(',', '').replace('원', '');  // 현재 할인 금액
					
					 $.ajax({
					        type: 'POST',
					        url: '/order/applyPoints',
					        data: { points: points, finalPrice: finalPrice, currentDiscount: currentDiscount },
					        success: function(response) {
					            $('#discount').text(formatPrice(response.totalDiscount)+ '원');  // 총 할인 금액을 포맷팅하여 표시
					            $('#final_price').text(formatPrice(response.finalPrice)+ '원');  // 최종 결제 금액을 포맷팅하여 표시
					        },
					        error: function(xhr) {
					            alert('포인트 적용 중 오류 발생');
					        }
					    });
	            });

	         // 아임포트 결제 요청 함수
	            $('#orderForm').on('submit', function(event) {
	                event.preventDefault(); // 기본 폼 제출 방지

	                // 아임포트 결제 요청 함수
	                var IMP = window.IMP; // 생략 가능
	                IMP.init('imp57000577'); // 아임포트에서 발급받은 가맹점 식별코드

	                IMP.request_pay({
	                    pg: 'html5_inicis', // PG사 (KCP, 이니시스, 카카오페이 등 지원 가능)
	                    pay_method: 'card', // 결제수단 (카드, 계좌이체 등)
	                    merchant_uid: 'O' + new Date().getTime(), // 고유한 주문번호 생성
	                    name: '주문명: 결제테스트', // 결제창에 표시될 상품명
	                    amount: 100, // 결제 금액
	                    buyer_email: 'test@example.com',
	                    buyer_name: '홍길동',
	                    buyer_tel: '010-1234-5678',
	                    buyer_addr: '서울특별시 강남구 삼성동',
	                    buyer_postcode: '123-456'
	                }, function (rsp) { // callback 함수
	                    if (rsp.success) {
	                        // 결제 성공 시 서버로 imp_uid 전송
	                        $.ajax({
	                            url: '/order/pay',
	                            method: 'POST',
	                            data: {
	                                imp_uid: rsp.imp_uid,
	                                merchant_uid: rsp.merchant_uid,
	                                paid_amount: rsp.paid_amount
	                            },
	                            success: function (response) {
	                                if (response.status === 'success') {
	                                    alert('결제가 완료되었습니다.');
	                                    window.location.href = '/order/confirmation'; // 결제 완료 페이지로 이동
	                                } else {
	                                    alert('결제 검증에 실패했습니다.');
	                                }
	                            }
	                        });
	                    } else {
	                        // 결제 실패 시
	                        alert('결제에 실패하였습니다. 에러 내용: ' + rsp.error_msg);
	                    }
	                });
	            });	         
	        });
    </script>
</head>
<body>
    <div>
        <h1>주문/결제</h1>

        <form id="orderForm" action="/order/pay" method="post">
            <div>
	            <h2>배송지 정보</h2>
	            
	            <label for="name">주문자 명:</label>
	            [[${name}]]<input type="hidden" th:value="${name}">
	            
	            <br>
	            
	            <label for="tel">연락처 : </label>
	            [[${tel}]]<input type="hidden" th:value="${tel}">
	            
	            <br>
	            
	            <label for="postcode">우편번호</label>
	            <input type="text" id="postcode" name="postcode"  th:value="${postcode}" placeholder="우편번호" readonly />
	            <button type="button" id="findPostcode">우편번호 찾기</button>
	            
	            <br>
	            
	            <label for="address">주소</label>
	            <input type="text" id="address" name="address" th:value="${address}" placeholder="주소" readonly />
	            
	            <br>
	            
	            <label for="address_detail">상세주소</label>
	            <input type="text" id="address_detail" name="address_detail" th:value="${address_detail}" placeholder="상세주소" />
	            
	            <br>
	            
	            <label for="delivery_memo">배송 요청 사항</label>
	            <select id="delivery_memo" name="delivery_memo">
	            	<option value="문 앞에 두고 가세요">문 앞에 두고 가세요</option>
                	<option value="배송 전에 미리 연락 주세요">배송 전에 미리 연락 주세요</option>
                	<option value="직접 수령할게요">직접 수령할게요</option>
                	<option value="경비실에 맡겨 주세요">경비실에 맡겨 주세요</option>
                	<option value="요청사항 없음">요청사항 없음</option>       
	            </select>	            	            
            </div>
            
            <div>
            <h2>주문 상품</h2>
	            <table>
	            <tr>
	                <td><img th:src="${product_img}" alt="Product Image" width="50"></td>
	                <td>[[${product_name}]]</td>
	                <td>[[${price}]]원</td>
	            </tr>
	        	</table>
            </div>
            
            <h3>재사용 포장재 반납 신청</h3>
        	<input type="checkbox" id="reusing" name="resuing"> 반납 신청

	        <h3>쿠폰 적용</h3>        
	        <!-- 쿠폰 선택 -->
	        <select id="couponSelect" name="couponSelect">
	        	<option value="" th:if="${#lists.isEmpty(coupons)}" >사용 가능한 쿠폰이 없어요</option>
				<option value="" th:if="${!#lists.isEmpty(coupons)}">쿠폰을 선택하세요</option>
	        
	        	<option th:each="coupon : ${coupons}"
	        			th:value="${coupon.coupon_code}"
	        			th:text="${coupon.coupon_name}">
	        	</option>
	        </select>
	
	        <h3>보유 포인트([[${points}]]p)</h3>
	        <input type="text" id="points" name="points" placeholder="1000">
	        <button type="button" id="applyPointsBtn">사용하기</button>
            
            <hr>
            <div class="order-summary">
            <p>총 상품 금액: <span id="total_price">80,000원</span></p>
            <p>총 할인 금액: <span id="discount">0원</span></p>
            <p>배송비: <span id="shipping_fee">0원</span></p>
            <p class="final_price">최종 결제 금액: <span id="final_price">80,000원</span></p>
        	</div>
            <hr>
             
            <button type="submit">결제 완료</button>
        </form>
    </div>
</body>
</html>